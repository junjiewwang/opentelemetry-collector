# Custom OpenTelemetry Collector Configuration
# This configuration demonstrates the enhanced OTLP receiver with control plane capabilities.
# Architecture: storageext -> controlplaneext/adminext

receivers:
  # Enhanced OTLP receiver with control plane support
  # Control plane APIs are served on the same HTTP port (4318) as OTLP
  enhanced_otlp:
    # Standard OTLP protocols configuration
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318
    
    # Control plane configuration (APIs served on same HTTP port)
    # Available endpoints:
    #   - POST /v1/control/config   - Configuration management
    #   - POST/GET /v1/control/tasks - Task management
    #   - POST/GET /v1/control/status - Status reporting
    #   - POST /v1/control/upload-chunk - Chunk upload
    #   - GET /health - Health check
    control_plane:
      enabled: true
      # Optional: customize the URL path prefix (default: /v1/control)
      # control_url_path_prefix: /v1/control
    
    # Token authentication for OTLP HTTP endpoints (Header-based)
    # When enabled, agents must provide a valid token in HTTP header
    # For attribute-based token validation, use the tokenauth processor
    token_auth:
      enabled: true
      # HTTP header name for token (default: Authorization)
      header_name: "Authorization"
      # Header value prefix (default: "Bearer ")
      header_prefix: "Bearer "
      # Inject validated token into resource attributes with this key
      # This allows downstream processors (like tokenauthprocessor) to access the token
      # Set to the same value as tokenauthprocessor's attribute_key
      inject_attribute_key: "token"

extensions:
  # Storage extension - provides Redis and Nacos client management
  # Other extensions reference this by name to reuse storage connections
  storage:
    # Redis connections (supports Standalone/Cluster/Sentinel modes)
    redis:
      default:
        # Standalone mode
        addr: "[[.Service.redis_apm.host]]:[[.Service.redis_apm.port]]"
        password: "[[ with .Service.redis_apm.user]][[.]]:[[end]][[.Service.redis_apm.pass]]"
        db: 0
        # Connection pool settings
        pool_size: 10
        dial_timeout: 5s
        read_timeout: 3s
        write_timeout: 3s
      
      # Example: Cluster mode
      # cluster:
      #   addrs:
      #     - "redis-node1:6379"
      #     - "redis-node2:6379"
      #     - "redis-node3:6379"
      #   password: ""
      
      # Example: Sentinel mode
      # sentinel:
      #   master_name: "mymaster"
      #   sentinel_addrs:
      #     - "sentinel1:26379"
      #     - "sentinel2:26379"
      #     - "sentinel3:26379"
      #   password: ""
    
    # Nacos connections
    nacos:
      default:
        server_addr: "[[.Service.nacos.host]]:[[.Service.nacos.port]]"
        namespace: ""  # Empty for default namespace
        username: "[[.Service.nacos.username]]"
        password: "[[.Service.nacos.password]]"
        timeout: 5s
        log_dir: "/tmp/nacos/log"
        cache_dir: "/tmp/nacos/cache"
        log_level: "warn"

  # Control plane extension - Agent interaction interface
  # Handles: Agent registration, heartbeat, task execution, status reporting
  controlplane:
    # Reference to storage extension for Redis/Nacos clients
    storage_extension: storage
    
    # Agent ID (auto-generated UUID if empty, or set via AGENT_ID env var)
    agent_id: ""
    
    # Agent registry configuration
    agent_registry:
      type: redis  # "memory" or "redis"
      redis_name: default  # Reference to redis connection name
      key_prefix: "otel:agents"
      heartbeat_ttl: 60s  # TTL for agent info (~3x heartbeat interval)
      offline_check_interval: 10s
      enable_events: true  # Enable Pub/Sub for agent events
    
    # Task manager configuration
    task_manager:
      type: redis  # "memory" or "redis"
      redis_name: default
      key_prefix: "otel:tasks"
      result_ttl: 24h  # TTL for task results
      workers: 4
      queue_size: 100
      default_timeout: 30s
    
    # Config manager configuration
    # Use "on_demand" for dynamic multi-agent config management
    config_manager:
      type: on_demand  # "memory", "nacos", or "on_demand"
      nacos_name: default
      # on_demand mode settings (configs are loaded when agents connect)
      on_demand:
        namespace: ""
        load_timeout: 5s
        max_retries: 3
        retry_interval: 1s
        cache_expiration: 5m
        cleanup_interval: 1m
    
    # Local task executor configuration
    task_executor:
      workers: 4
      queue_size: 100
      default_timeout: 30s
    
    # Status reporter configuration
    status_reporter:
      completed_tasks_buffer: 50
      health_check_interval: 10s
    
    # Token manager for validating agent tokens
    # Shares the same backend as admin extension's token_manager
    token_manager:
      type: redis  # "memory" or "redis"
      redis_name: default
      key_prefix: "otel:apps"
      token_length: 32

  # Admin extension - Management HTTP API interface
  # Provides REST APIs for frontend management
  admin:
    # Reference to storage extension
    storage_extension: storage
    
    # HTTP server configuration
    http:
      endpoint: "0.0.0.0:8088"
      read_timeout: 30s
      write_timeout: 30s
      idle_timeout: 60s
    
    # CORS configuration
    cors:
      enabled: true
      allowed_origins:
        - "*"
      allowed_methods:
        - "GET"
        - "POST"
        - "PUT"
        - "DELETE"
        - "OPTIONS"
      allowed_headers:
        - "Authorization"
        - "Content-Type"
        - "X-API-Key"
      allow_credentials: false
      max_age: 86400
    
    # Authentication configuration
    auth:
      enabled: true
      type: api_key  # "basic", "jwt", or "api_key"
      
      # Basic auth configuration
      # basic:
      #   username: admin
      #   password: admin123
      
      # JWT auth configuration
      # jwt:
      #   secret: "your-jwt-secret-key"
      #   issuer: "otel-collector"
      #   audience: "admin-api"
      
      # API key auth configuration
      api_key:
        header: "X-API-Key"
        keys:
          - "your-api-key-1"
          - "your-api-key-2"
    
    # Agent registry (shares same backend as controlplane)
    agent_registry:
      type: redis
      redis_name: default
      key_prefix: "otel:agents"
      heartbeat_ttl: 60s
      offline_check_interval: 10s
      enable_events: true
    
    # Task manager (shares same backend as controlplane)
    task_manager:
      type: redis
      redis_name: default
      key_prefix: "otel:tasks"
      result_ttl: 24h
      workers: 4
      queue_size: 100
      default_timeout: 30s
    
    # Config manager (on_demand mode for multi-agent support)
    # Configs are loaded on-demand when agents connect with their token
    config_manager:
      type: on_demand  # "memory", "nacos", or "on_demand"
      nacos_name: default
      on_demand:
        namespace: ""
        load_timeout: 5s
        max_retries: 3
        retry_interval: 1s
        cache_expiration: 5m
        cleanup_interval: 1m
    
    # Token manager for app/token management
    # Apps are created via Admin API, each app gets a unique token
    token_manager:
      type: redis  # "memory" or "redis"
      redis_name: default
      key_prefix: "otel:apps"
      token_length: 32

  # Memory limiter extension
  memory_limiter:
    check_interval: 1s
    limit_mib: 1024
    spike_limit_mib: 256

  # zPages for debugging
  zpages:
    endpoint: 0.0.0.0:55679

connectors:
  # Span metrics connector - generates RED metrics from traces
  # RED: Rate (request count), Errors, Duration
  spanmetrics:
    # Histogram configuration for latency metrics
    histogram:
      explicit:
        buckets: [5ms, 10ms, 25ms, 50ms, 100ms, 250ms, 500ms, 1s, 2.5s, 5s, 10s]
    # Dimensions to add as metric labels (from span attributes)
    dimensions:
      - name: http.method
        default: GET
      - name: http.status_code
      - name: http.route
      - name: rpc.method
      - name: rpc.service
    # Metrics flush interval
    metrics_flush_interval: 15s
    # Namespace for generated metrics
    namespace: traces.spanmetrics
    # Resource metrics key attributes
    resource_metrics_key_attributes:
      - service.name
      - service.namespace
      - deployment.environment

processors:
  # Batch processor for efficient data export
  batch:
    send_batch_size: 1000
    timeout: 10s
    send_batch_max_size: 1500

  # Memory limiter processor
  memory_limiter:
    check_interval: 1s
    limit_mib: 800
    spike_limit_mib: 200

  # Token auth processor - validates token from resource attributes
  # Use this for protocols that don't support HTTP headers (e.g., SkyWalking, Jaeger)
  # or when token is embedded in resource attributes
  tokenauth:
    # Resource attribute key to extract token from
    attribute_key: "token"
    # Action when token validation fails: "drop" or "pass"
    action: drop
    # Control plane extension name for token validation
    control_plane_extension: controlplane
    # Log dropped data due to invalid tokens
    log_dropped: true
    # Token validation cache configuration
    cache:
      enabled: true
      # TTL for valid token cache entries (seconds)
      # Valid tokens are cached longer for performance
      valid_ttl_seconds: 300  # 5 minutes
      # TTL for invalid token cache entries (seconds)
      # Shorter TTL allows quick recovery when tokens become valid
      invalid_ttl_seconds: 30  # 30 seconds
      # Maximum number of cache entries
      max_size: 10000
      # Background cleanup interval (seconds)
      cleanup_interval_seconds: 60

exporters:
  # Debug exporter for development
  debug:
    verbosity: detailed
    sampling_initial: 5
    sampling_thereafter: 200

  # OTLP HTTP exporter
  otlphttp/jaeger:
    endpoint: [[ .Service.otlp_jeager.url ]]


  # Prometheus Remote Write exporter for metrics
  prometheusremotewrite:
    endpoint: [[ .Service.prometheus_server.url ]]
    tls:
      insecure: true
    resource_to_telemetry_conversion:
      enabled: true

service:
  # Extensions load order: storage must be first (dependency for others)
  extensions: [storage, controlplane, admin, memory_limiter, zpages]
  
  pipelines:
    traces:
      receivers: [enhanced_otlp]
      # tokenauth processor validates token from resource attributes
      # Place it before other processors for early rejection of invalid data
      processors: [tokenauth, memory_limiter, batch]
      exporters: [otlphttp/jaeger, spanmetrics]
    
    # Metrics from spanmetrics connector
    metrics/spanmetrics:
      receivers: [spanmetrics]
      processors: [batch]
      exporters: [prometheusremotewrite]
    
    metrics:
      receivers: [enhanced_otlp]
      processors: [tokenauth, memory_limiter, batch]
      exporters: [prometheusremotewrite]
    
    # logs:
    #   receivers: [enhanced_otlp]
    #   processors: [tokenauth, memory_limiter, batch]
    #   exporters: [debug]

  telemetry:
    logs:
      level: info
      development: false  # Set to false to disable stack traces in warn logs
    metrics:
      level: detailed
      readers:
        - pull:
            exporter:
              prometheus:
                host: 0.0.0.0
                port: 8888
