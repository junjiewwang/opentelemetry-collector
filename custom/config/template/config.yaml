# Custom OpenTelemetry Collector Configuration
# This configuration demonstrates the enhanced OTLP receiver with control plane capabilities.

receivers:
  # Enhanced OTLP receiver with control plane support
  # Control plane APIs are served on the same HTTP port (4318) as OTLP
  enhanced_otlp:
    # Standard OTLP protocols configuration
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318
    
    # Control plane configuration (APIs served on same HTTP port)
    # Available endpoints:
    #   - POST /v1/control/config   - Configuration management
    #   - POST/GET /v1/control/tasks - Task management
    #   - POST/GET /v1/control/status - Status reporting
    #   - POST /v1/control/upload-chunk - Chunk upload
    #   - GET /health - Health check
    control_plane:
      enabled: true
      # Optional: customize the URL path prefix (default: /v1/control)
      # control_url_path_prefix: /v1/control

extensions:
  # Control plane extension for configuration, task, and status management
  controlplane:
    agent_id: ""  # Auto-generated if not provided, or set via AGENT_ID env var
    store:
      type: memory  # or "file" for persistence
      path: ""      # Required if type is "file"
    task_executor:
      workers: 4
      queue_size: 100
      default_timeout: 30s
    status_reporter:
      completed_tasks_buffer: 50
      health_check_interval: 10s

  # Memory limiter extension
  memory_limiter:
    check_interval: 1s
    limit_mib: 1024
    spike_limit_mib: 256

  # zPages for debugging
  zpages:
    endpoint: 0.0.0.0:55679

connectors:
  # Span metrics connector - generates RED metrics from traces
  # RED: Rate (request count), Errors, Duration
  spanmetrics:
    # Histogram configuration for latency metrics
    histogram:
      explicit:
        buckets: [5ms, 10ms, 25ms, 50ms, 100ms, 250ms, 500ms, 1s, 2.5s, 5s, 10s]
    # Dimensions to add as metric labels (from span attributes)
    dimensions:
      - name: http.method
        default: GET
      - name: http.status_code
      - name: http.route
      - name: rpc.method
      - name: rpc.service
    # Exclude specific dimensions
    # exclude_dimensions: []
    # Metrics flush interval
    metrics_flush_interval: 15s
    # Namespace for generated metrics
    namespace: traces.spanmetrics
    # Resource metrics key attributes
    resource_metrics_key_attributes:
      - service.name
      - service.namespace
      - deployment.environment

processors:
  # Batch processor for efficient data export
  batch:
    send_batch_size: 1000
    timeout: 10s
    send_batch_max_size: 1500

  # Memory limiter processor
  memory_limiter:
    check_interval: 1s
    limit_mib: 800
    spike_limit_mib: 200

exporters:
  # Debug exporter for development
  debug:
    verbosity: detailed
    sampling_initial: 5
    sampling_thereafter: 200


  # OTLP HTTP exporter
  otlphttp/jaeger:
    endpoint: [[ .Service.otlp_jeager.url ]]


  # Prometheus Remote Write exporter for metrics
  prometheusremotewrite:
    endpoint: [[ .Service.prometheus_server.url ]]
    tls:
      insecure: true
    # Optional: add external labels
    # external_labels:
    #   cluster: my-cluster
    #   environment: production
    # Optional: resource to telemetry conversion
    resource_to_telemetry_conversion:
      enabled: true

service:
  extensions: [controlplane, memory_limiter, zpages]
  
  pipelines:
    traces:
      receivers: [enhanced_otlp]
      processors: [memory_limiter, batch]
      exporters: [debug, otlphttp/jaeger, spanmetrics]
    
    # Metrics from spanmetrics connector
    metrics/spanmetrics:
      receivers: [spanmetrics]
      processors: [batch]
      exporters: [prometheusremotewrite]
    
    metrics:
      receivers: [enhanced_otlp]
      processors: [memory_limiter, batch]
      exporters: [debug, prometheusremotewrite]
    
    logs:
      receivers: [enhanced_otlp]
      processors: [memory_limiter, batch]
      exporters: [debug]

  telemetry:
    logs:
      level: info
      development: true
    metrics:
      level: detailed
      readers:
        - pull:
            exporter:
              prometheus:
                host: 0.0.0.0
                port: 8888
